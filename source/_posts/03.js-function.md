title: JavaScript 常用函数库
date: 2016-10-16
tags: [JavaScript,jQuery]
---

## JSON类

### 快速把 url 查询参数转为 JSON 对象
`Object.fromEntries(new URLSearchParams('a=1&b=2'))`

### 将 JSON 对象序列化为 x-www-form-urlencoded 格式的字符串(使用 & 符号连接)
``` javascript
var serialize = function(obj) {
    let query = '',
        name, value, fullSubName, subName, subValue, innerObj, i;
    for (name in obj) {
        value = obj[name];

        if (value instanceof Array) {
            for (i = 0; i < value.length; ++i) {
                subValue = value[i];
                fullSubName = name + '[' + i + ']';
                innerObj = {};
                innerObj[fullSubName] = subValue;
                query += serialize(innerObj) + '&';
            }
        } else if (value instanceof Object) {
            for (subName in value) {
                subValue = value[subName];
                fullSubName = name + '[' + subName + ']';
                innerObj = {};
                innerObj[fullSubName] = subValue;
                query += serialize(innerObj) + '&';
            }
        } else if (value !== undefined && value !== null) {
            query += encodeURIComponent(name) + '=' + encodeURIComponent(value) + '&';
        }
    }
    return query.length ? query.substr(0, query.length - 1) : query;
};
```

### 根据给定的文件内容(字符串或二进制形式)、名称、类型，实现本地下载文件
``` javascript
var downloadFile = function(fileName, fileContent, fileType) {
    let blob;
    let downloadUrl = '';
    if (window.Blob && window.URL && window.URL.createObjectURL) {
        blob = new Blob([fileContent], {type: fileType});
        downloadUrl = URL.createObjectURL(blob);
    } else {
        downloadUrl = 'data:' + fileType + ';charset=utf-8,' + encodeURI(fileContent);
    }
    // 兼容 IE10+
    if (typeof window.navigator.msSaveBlob !== 'undefined') {
        window.navigator.msSaveBlob(blob, fileName);
    } else {
        let link = document.createElement('a');
        // 兼容 Safari9-
        if (typeof link.download === 'undefined') {
            if (fileType.indexOf('zip') > -1) {
                downloadUrl = 'data:' + fileType + ';base64,' + fileContent.toString('base64');
            } else {
                downloadUrl = 'data:application/file;charset=utf-8,' + encodeURI(fileContent);
            }
            window.location = downloadUrl;
        } else {
            // 兼容 Firefox、Chrome、Safari10+
            link.href = downloadUrl;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    }
};
```

## 时间类

### 将 Date对象 转化为指定格式的字符串
> 用法：`dateFormat(date, 'YYYY年MM月DD日 q季度 周d N午H点 hh时mm分ss秒S毫秒')`
默认值 'YYYY-MM-DD hh:mm:ss'
年(Y) 月(M)、日(D)、12小时(H)、上下午(N)、24小时(h)、分(m)、秒(s)、毫秒(S)、周(d)、季度(q)

``` javascript
var dateFormat = function(date, format, en) {
    var self = new Date(date);
    var fmt = format || 'YYYY-MM-DD hh:mm:ss';
    var o = {
        'M+': self.getMonth() + 1,
        'D+': self.getDate(),
        'h+': self.getHours(),
        'H+': self.getHours() % 12 === 0 ? 12 : self.getHours() % 12,
        'N': self.getHours() >= 12 ? (en ? 'PM' : '下') :  (en ? 'AM' : '上'),
        'm+': self.getMinutes(),
        's+': self.getSeconds(),
        'q+': Math.floor((self.getMonth() + 3) / 3),
        'S': self.getMilliseconds()
    };
    if (/(Y+)/.test(fmt)) {
        fmt = fmt.replace(RegExp.$1, (self.getFullYear() + '').substr(4 - RegExp.$1.length));
    }
    for (var k in o) {
        if (new RegExp('(' + k + ')').test(fmt)) {
            fmt = fmt.replace(RegExp.$1, (RegExp.$1.length === 1) ? (o[k]) : (('00' + o[k]).substr(('' + o[k]).length)));
        }
    }
    var week = ['\u65e5', '\u4e00', '\u4e8c', '\u4e09', '\u56db', '\u4e94', '\u516d'];
    var weekEn = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    if (/(d+)/.test(fmt)) {
        if (en) {
            fmt = fmt.replace(RegExp.$1, (RegExp.$1.length > 1) ? weekEn[self.getDay()].substr(0, 3) : weekEn[self.getDay()]);
        } else {
            fmt = fmt.replace(RegExp.$1, ((RegExp.$1.length > 1) ? (RegExp.$1.length > 2 ? '\u661f\u671f' : '\u5468') : '') + week[self.getDay()]);
        }
    }
    return fmt;
};
```

### 计算相隔天数
``` javascript
var calDay = function(start, end) {
    var ageDifMs = (new Date(end) - 0) - (new Date(start) - 0);
    return Math.ceil(ageDifMs / (1000 * 60 * 60 * 24));
}
console.log(calDay('2013-11-28', '2014-11-28'));
```

### 计算年龄
``` javascript
var calAge = function(date) {
    var ageDifMs = Date.now() - (new Date(date) - 0);
    return Math.abs(new Date(ageDifMs).getFullYear() - 1970);
}
console.log(calAge('2008-08-08'));
```

## 数字、字符串类

### 获取指定区间的任意数
``` javascript
var getRandom = function(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}
```

### 用 0 补全位数（默认为 2 位）：
``` javascript
var prefix = function(num, length) {
    var length = length > 2 ? length : 2;
    return (num / Math.pow(10, length)).toFixed(length).substr(2);
}
```
### 获取字符串的字节长度（即一个汉字按两个字长算）
``` javascript
var getLen = function(str) {
    return (str + '').replace(/[^\x00-\xff]/g, '**').length;
};
```

### 根据字节长度截取字符串（需配合前一方法）
``` javascript
var subLen = function(str, maxLen) {
    let len = maxLen;
    let result = str.slice(0, len);
    while (getLen(result) > maxLen) {
        result = result.slice(0, --len);
    }
    return result;
};
```

### 根据字节长度截取字符串并附加标记（如...）
``` javascript
var shorten = function(str, maxLen, token) {
    let len = str.length;
    let count = 0;
    let i;
    for (i = 0; i < len; i++) {
        if (str[i].match(/[^\x00-\xff]/ig) !== null) {
            count += 2;
        } else {
            count += 1;
        }
        if (count > maxLen) {
            break;
        }
    }
    if (len > i) {
        str = str.substring(0, i) + (token || '');
    }
    return str;
};
```

### 首字母大写
``` javascript
var capitalize = function(str) {
    return str.charAt(0).toUpperCase() + str.substr(1).toLowerCase();
};
```

### 每个词首字母大写
``` javascript
var camelCase = function(str) {
    return str.replace(/\w\S*/g, function(txt) {
        return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
    });
};
```

### 下划线转首字母大写
``` javascript
var snakeToCamel = function(str) {
    return str.split('_').map(function(item) {
        return capitalize(item);
    }).join(' ');
};
```

### 数字添加千分位
``` javascript
var numberFormat = function(number) {
    if (window.Intl) {
        // IE10、Safari9 不支持
        let inf = new Intl.NumberFormat();
        return inf.format(number);
    } else {
        // 正则式
        return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    // Safari 不支持
    // return parseFloat(number).toLocaleString();
};
```

### 替换字符串中指定位置的字段
``` javascript
var bindData = function(str, data) {
    var m, result = str;
    while (m = /%\{\s*([^\}\s]+)\s*\}/.exec(result)) {
        result = result.replace(m[0], data[m[1]] || '??');
    }
    return result;
};
// 用法：
var data = {
    'brown': 'red',
    'lazy': 'slow'
  };
var test = bindData('The quick %{brown} fox jumped over the %{lazy} dog', data);
=> The quick red fox jumped over the slow dog
```


### 颜色转换
``` javascript
function rgbToHex(r, g, b) {
    return '#' + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
}
function hexToRgb(hex) {
    // Expand shorthand form (e.g. "03F") to full form (e.g. "0033FF")
    var shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
    hex = hex.replace(shorthandRegex, function(m, r, g, b) {
        return r + r + g + g + b + b;
    });

    var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
    } : null;
}
```

## 数组类

### 随机排序

Fisher–Yates shuffle 洗牌算法
``` javascript
Array.prototype.shuffle = function() {
    var input = this;
    for (var i = input.length-1; i >=0; i--) {
        var randomIndex = Math.floor(Math.random()*(i+1));
        var itemAtIndex = input[randomIndex];
        input[randomIndex] = input[i];
        input[i] = itemAtIndex;
    }
    return input;
}
```

[社区 ES5 改写版](https://blog.oldj.net/2017/01/23/shuffle-an-array-in-javascript/)
``` javascript
var shuffle = function(array) {
    var m = array.length,
        t, i;
    while (m) {
        i = Math.floor(Math.random() * m--);
        t = array[m];
        array[m] = array[i];
        array[i] = t;
    }
    return array;
}
```

[另外一种随机洗牌算法](https://github.com/rccoder/blog/issues/14)
``` javascript
var arr = [];

for (let i = 0; i < 100; i++) {
    arr[i] = i + 1;
}
for (let i = 0; i < 100 - 1; i++) {
    let index = getRandom(i + 1, 100 - 1);
    arr[i] = arr[i] ^ arr[index];
    arr[index] = arr[index] ^ arr[i];
    arr[i] = arr[i] ^ arr[index];
}
console.log(arr.join('、'));
```

### 提取数组内元素的指定属性并转换为字符串
convertPropToStr(arr) => str
``` javascript
var convertPropToStr = function(arr, propertyName) {
    var str = [];
    var length = arr.length;
    if (length > 0) {
        for (var i = 0; i < length; i++) {
            str.push(arr[i][propertyName]);
        }
    }
    return str.join(",");
};
```

### 删除数组中重复的值
``` javascript
var unique = function(array) {
    return array.filter(function(value, index, self) {
        return self.indexOf(value) === index;
    });
};
```
### 数组交集
``` javascript
var intersection = function(a, b) {
    return a.filter(function(item) { return b.indexOf(item) !== -1;});
};
```

### 数组并集
``` javascript
var union = function(a, b) {
    let orphan = b.filter(function(item) { return a.indexOf(item) === -1;});
    return a.concat(orphan);
};
```

### 删除数组中指定的值（默认删除无效值：undefined、null）
``` javascript
var clean = function(arr, deleteValue) {
    for (var i = 0; i < arr.length; i++) {
        if (arr[i] === deleteValue) {
            arr.splice(i, 1);
            i--;
        }
    }
    return arr;
}
var arrTest = ['','One','Two','',, 'Three','','Four'];
console.log(clean(arrTest, ''));
var arrTest2 = [1,2,,3,,3,,,,,,4,,4,,5,,6,,,,];
console.log(clean(arrTest2));
```

### 数组浅比较
``` javascript
var isArrayEqual = function(a, b) {
    if (a === b) {
        return true;
    }
    if (a === null || b === null) {
        return false;
    }
    if (a.length !== b.length) {
        return false;
    }
    let cloneA = a.slice().sort();
    let cloneB = b.slice().sort();

    for (let i = 0; i < cloneA.length; ++i) {
        if (cloneA[i] !== cloneB[i]) {
            return false;
        }
    }
    return true;
};
```

## 对象类

### 浅复制或合并
``` javascript
var assign = Object.assign || (function(target) {
    for (let i = 1; i < arguments.length; i++) {
        let source = arguments[i];
        for (let key in source) {
            if (Object.prototype.hasOwnProperty.call(source, key)) {
                target[key] = source[key];
            }
        }
    }
    return target;
});
```

### 浅复制
``` javascript
var clone = function(obj) {
    let cloned = {};
    Object.keys(obj).forEach(function(i) {
        cloned[i] = obj[i];
    });
    return cloned;
};
```

### 浅比较
``` javascript
var isEqual = function(a, b) {
    if (!a && !b) {
        return true;
    }
    if (!a || !b) {
        return false;
    }
    if (Object.keys(a).length !== Object.keys(b).length) {
        return false;
    }
    return Object.keys(a).every(function(key) {
        return a[key].toLowerCase() === b[key].toLowerCase();
    });
};
```

### 判断空值，避免直接布尔运算时误判 0 和 false
``` javascript
var isNil = function(value) {
    return value === null || value === undefined || value === '';
};
```

### 判断数字，避免使用 isNaN 时误判空字符串和 null
``` javascript
var isNumber = function(value) {
    return !isNaN(value - parseFloat(value));
};
```

### 判断空对象 {}
``` javascript
var isEmpty = function(obj) {
    if (obj === null || obj === undefined) {
        return true;
    }
    return Object.keys(obj).length === 0 && obj.constructor === Object;
};
```

### 获取对象类型 [Juriy Zaytsev（kangax）](http://github.com/kangax/protolicious/blob/master/experimental/__getClass.js)
``` javascript
var getType = function(obj) {
    return Object.prototype.toString.call(obj).match(/^\[object\s(.*)\]$/)[1];
}
```

## jQuery 扩展类

### 用 jQuery 检测元素是否定义了指定行内样式（style="xxx:yyy"）
``` javascript
(function ($) {
    $.fn.inlineStyle = function (prop) {
        return this.prop("style")[$.camelCase(prop)];
    };
}(jQuery));
// 用法：
$(element).inlineStyle('xxx') // true or false
```

### 计算元素的尺寸（基于 jQuery，支持隐藏元素，兼容 IE9+）
measure(elem) => {top:, right:, bottom:, left:, width: IE8- 无此属性, height: IE8- 无此属性}
``` javascript
var measure = function(obj) {
    obj.css({
        position: 'absolute',
        visibility: 'hidden'
    }).attr('style', 'display: block !important');
    var rect = obj[0].getBoundingClientRect();
    obj.css({
        position: '',
        visibility: '',
        display: ''
    });
    return rect;
}
```

### 延时触发效果
使用: hover 伪类实现一些效果，可以使用 transition-delay 来延时处理，防止触发太敏感，干扰用户
也可以使用 js 脚本来实现（jQuery 封装）：
``` javascript
(function($){
    $.fn.hoverDelay = function(options){
        var defaults = {
            hoverDuring: 200,
            outDuring: 200,
            hoverEvent: function(){
                $.noop();
            },
            outEvent: function(){
                $.noop();
            }
        };
        var sets = $.extend(defaults,options || {});
        var hoverTimer, outTimer;
        return $(this).each(function(){
            $(this).hover(function(){
                clearTimeout(outTimer);
                hoverTimer = setTimeout(sets.hoverEvent, sets.hoverDuring);
            },function(){
                clearTimeout(hoverTimer);
                outTimer = setTimeout(sets.outEvent, sets.outDuring);
            });
        });
    }
})(jQuery);
// 用法：
$("#test").hoverDelay({
    hoverEvent: function(){
        alert("经过我！");
    }
});
```

### 防抖 Debounce
``` javascript
var debounce = function(fn, delay) {

    // 定时器，用来 setTimeout
    var timer;

    // 返回一个函数，这个函数会在一个时间区间结束后的 delay 毫秒时执行 fn 函数
    return function() {

        // 保存函数调用时的上下文和参数，传递给 fn
        var context = this;
        var args = arguments;
        // 每次这个返回的函数被调用，就清除定时器，以保证不执行 fn
        clearTimeout(timer);

        // 当返回的函数被最后一次调用后（也就是用户停止了某个连续的操作），
        // 再过 delay 毫秒就执行 fn
        timer = setTimeout(function() {
            fn.apply(context, args);
        }, delay);
    };
};
```
